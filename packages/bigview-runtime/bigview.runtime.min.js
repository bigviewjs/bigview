function _unescapeHtml(e){var t=document.createElement("div");return e.replace(/&[#0-9a-z]+;/gi,function(e){return t.innerHTML=e,t.innerText})}var _bigviewDebug=function(e,t){var r=(new Date).getTime(),i=!1;return"undefined"!=typeof process?i=process.env._bigview:"undefined"!=typeof window&&(i=window.localStorage&&localStorage._bigview),function(e,t){i&&(e=e||"bigview",t=t||"",console.log("Module: "+e+"  "+t+"%c [+"+((new Date).getTime()-r)+"ms];","color: blue"))}}(),_isIE8=function(){return document.documentMode<9};Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)});var _errorTemplate='<div class="bigview-error-template" style="position:relative;height:100%; text-align:center;padding-top:10px;">';_errorTemplate+='<img style="display:inline-block;height:50px;" src="https://gw.alicdn.com/tfs/TB1iNyybgmTBuNjy1XbXXaMrVXa-100-100.png" />',_errorTemplate+="<p>Some Errors ~</p>",_errorTemplate+='<p><a href="javascript:;" class="js-bigview-retry" style="display:inline-block; padding:4px 12px;line-height:32px; text-decoration:none; color: blue;">Retry </a>';var BigEvent=function(){};BigEvent.prototype.on=function(e,t){this._listeners=this._listeners||{},this._listeners[e]=this._listeners[e]||[],this._listeners[e].push(t)},BigEvent.prototype.off=function(e,t){this._listeners=this._listeners||{},this._listeners[e].splice(this._listeners[e].indexOf(t),1)},BigEvent.prototype.trigger=function(e){this._listeners=this._listeners||{};for(var t=arguments[1]?arguments[1]:null,r=this._listeners[e]||[],i=0;i<r.length;i++){var n=r[i];t?n.call(this,t):n.call(this)}},BigEvent.extend=function(e){for(var t=["on","off","trigger"],r=0;r<t.length;r++){var i=t[r];"function"==typeof e?e.prototype[i]=BigEvent.prototype[i]:e[i]=BigEvent.prototype[i]}};var _jsMap={},_checkJSLoadReady=function(e){if(!_jsMap[e])return!1;for(var t=_jsMap[e],r=0;r<t.length;r++)if(t[r]&&!t[r].ready)return!1;return!0},_setJSLoadStatus=function(e,t){for(var r=_jsMap[t],i=0;i<r.length;i++)r[i].src===e&&(r[i].ready=1)},Bigview=function(){var e=this;this.endPagelets=[],this.endScripts=[],this.errorRetry=!1,this.on("end",function(){for(var t=0;t<this.endPagelets.length;t++)e.handlePayload(this.endPagelets[t]);for(var r=0;r<this.endScripts.length;r++)e.handlePayload(this.endScripts[r])}),this.log=function(e,t){_bigviewDebug(e,t)},this.view=function(t){e.trigger("pageletArrive",t),t.domid&&e.trigger(t.domid,t)},this.ready=function(t){e.trigger("ready",t)},this.end=function(e){this.trigger("end",e)},this.error=function(t){if(this.trigger("error",t),this.log(t.domid," occurs some error!"),this.errorRetry){var r=this.replaceHtml(t.domid,this.errorTemplate).querySelector(".js-bigview-retry");r&&r.addEventListener("click",function(){e._request(t)})}},this.beforePageletArrive=function(t){e.trigger("beforePageletArrive",t)},this.on("pageletArrive",function(e){if("end"===e.lifecycle)return this.endPagelets.push(e);this.handlePayload(e)}),this.handlePayload=function(t){if(t.error)return e.error(t);if(e.log(t.domid,"pageletArrive"),t.css)for(var r=Array.isArray(t.css)?t.css:[t.css],i=0;i<r.length;i++)e.insertCss(r[i]);if(t.domid&&!t.error&&"object"==typeof document&&e.replaceHtml(t.domid,t.html,t.attr),t.js){for(var n=Array.isArray(t.js)?t.js:[t.js],o=[],s=0;s<n.length;s++){var a=n[s];if(_isIE8())return e.endScripts.push(a);o.push({src:a,ready:0}),e.insertScript(a,t)}_jsMap[t.domid]=o}},this.replaceHtml=function(e,t,r){var i=document.getElementById(e);if(i){var n=document.getElementById(e+"-code");t&&/\/script/.test(t)&&(t=_unescapeHtml(t)),n&&(t=n.innerHTML);var o=i.cloneNode(!1);if(r&&"object"==typeof r){for(var s in r)o.setAttribute(s,r[s]);o.setAttribute("modshow",1)}if(t){if(o.innerHTML=t,i.parentNode.replaceChild(o,i),_isIE8()){var a=/<script\b[^>]*>([\s\S]*?)<\/script>/gm.exec(t);if(a&&a[1]){var c=document.createElement("SCRIPT");c.text=a[1],o.appendChild(c)}return o}if(!n){for(var l=o.getElementsByTagName("script"),d=l.length,p=0;p<d;p++){var g=l[p],u=document.createElement("SCRIPT");g.src?(u.src=g.src,g.parentNode.replaceChild(u,g)):g.innerText.trim()&&(u.text=g.innerText,g.parentNode.replaceChild(u,g))}return o}}}},this.insertCss=function(e){var t=document.createElement("link");t.rel="stylesheet",t.href=e,document.getElementsByTagName("head")[0].appendChild(t)},this.insertScript=function(t,r){if(t){var i=document.createElement("SCRIPT");i.src=t,i.async=!0,i.onload=function(){_setJSLoadStatus(t,r.domid),e.handleCallback(r.callback,r.domid)},document.body.appendChild(i)}},this.handleCallback=function(e,t){"string"==typeof e&&(e=new Function(e).bind(this)),"function"==typeof e&&_checkJSLoadReady(t)&&e()},this._request=function(t){var r=location.href;location.search?r+="&_pagelet_id="+t.domid:r+="?_pagelet_id="+t.domid;var i=new XMLHttpRequest;i.onload=function(t){var r=i.response,n={};try{n=JSON.parse(r)}catch(e){401===i.status&&_bigviewDebug("access_denied",i.statusText)}n.error=!1,e.view(n)},i.onerror=function(r){e.error(t),console.error(r)},i.open("GET",r,!0),i.setRequestHeader("bigview_error_time",Date.now()),i.send()}};BigEvent.extend(Bigview);var _bigview=new Bigview;_bigview.errorTemplate=_errorTemplate,"function"==typeof define&&define.amd?define("bigview",[],function(){return _bigview}):"object"==typeof exports?module.exports=_bigview:window.bigview=_bigview;
