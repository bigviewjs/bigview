var _bigviewDebug=function(e,t){var r=(new Date).getTime(),i=!1;return"undefined"!=typeof process?i=process.env._bigview:"undefined"!=typeof window&&(i=window.localStorage&&localStorage._bigview),function(e,t){i&&(e=e||"bigview",t=t||"",console.log("Module: "+e+"  "+t+"%c [+"+((new Date).getTime()-r)+"ms];","color: blue"))}}(),_isIE8=function(){return document.documentMode<9};Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)});var _errorTemplate='<div class="bigview-error-template" style="position:relative;height:100%; text-align:center;padding-top:10px;">';_errorTemplate+='<img style="display:inline-block;height:50px;" src="https://gw.alicdn.com/tfs/TB1iNyybgmTBuNjy1XbXXaMrVXa-100-100.png" />',_errorTemplate+="<p>Some Errors ~</p>",_errorTemplate+='<p><a href="javascript:;" class="js-bigview-retry" style="display:inline-block; padding:4px 12px;line-height:32px; text-decoration:none; color: blue;">Retry </a>';var BigEvent=function(){};BigEvent.prototype.on=function(e,t){this._listeners=this._listeners||{},this._listeners[e]=this._listeners[e]||[],this._listeners[e].push(t)},BigEvent.prototype.off=function(e,t){this._listeners=this._listeners||{},this._listeners[e].splice(this._listeners[e].indexOf(t),1)},BigEvent.prototype.trigger=function(e){this._listeners=this._listeners||{};for(var t=arguments[1]?arguments[1]:null,r=this._listeners[e]||[],i=0;i<r.length;i++){var n=r[i];t?n.call(this,t):n.call(this)}},BigEvent.extend=function(e){for(var t=["on","off","trigger"],r=0;r<t.length;r++){var i=t[r];"function"==typeof e?e.prototype[i]=BigEvent.prototype[i]:e[i]=BigEvent.prototype[i]}};var Bigview=function(){var e=this;this.endPagelets=[],this.endScripts=[],this.errorRetry=!1,this.on("end",function(){for(var t=0;t<this.endPagelets.length;t++)e.handlePayload(this.endPagelets[t]);for(var r=0;r<this.endScripts.length;r++)e.handlePayload(this.endScripts[r])}),this.log=function(e,t){_bigviewDebug(e,t)},this.view=function(t){e.trigger("pageletArrive",t),t.domid&&e.trigger(t.domid,t)},this.ready=function(t){this.log("ready"),e.trigger("ready",t)},this.end=function(e){this.log("end"),this.trigger("end",e)},this.error=function(t){if(this.trigger("error",t),this.log(t.domid," occurs some error!"),this.errorRetry){var r=this.replaceHtml(t.domid,this.errorTemplate).querySelector(".js-bigview-retry");r&&r.addEventListener("click",function(){e._request(t)})}},this.beforePageletArrive=function(t){e.trigger("beforePageletArrive",t)},this.on("pageletArrive",function(e){if("end"===e.lifecycle)return this.endPagelets.push(e);this.handlePayload(e)}),this.handlePayload=function(t){if(t.error)return e.error(t);if(e.log(t.domid,"pageletArrive"),t.css)for(var r=Array.isArray(t.css)?t.css:[t.css],i=0;i<r.length;i++)e.insertCss(r[i]);if(t.domid&&t.html&&!t.error&&e.replaceHtml(t.domid,t.html,t.attr),t.js)for(var n=Array.isArray(t.js)?t.js:[t.js],o=0;o<n.length;o++){var s=n[o];if(_isIE8())return e.endScripts.push(s);e.insertScript(s)}},this.replaceHtml=function(e,t,r){var i="string"==typeof e?document.getElementById(e):e;if(i){var n=i.cloneNode(!1);if(r&&"object"==typeof r){for(var o in r)n.setAttribute(o,r[o]);n.setAttribute("modshow",1)}if(n.innerHTML=t,i.parentNode.replaceChild(n,i),_isIE8()){var s=/<script\b[^>]*>([\s\S]*?)<\/script>/gm.exec(t);if(s&&s[1]){var a=document.createElement("SCRIPT");a.text=s[1],n.appendChild(a)}return n}for(var l=n.getElementsByTagName("script"),c=l.length,d=0;d<c;d++){var g=l[d],p=document.createElement("SCRIPT");g.src?(p.src=g.src,g.parentNode.replaceChild(p,g)):g.innerText.trim()&&(p.text=g.innerText,g.parentNode.replaceChild(p,g))}return n}},this.insertCss=function(e){var t=document.createElement("link");t.rel="stylesheet",t.href=e,document.getElementsByTagName("head")[0].appendChild(t)},this.insertScript=function(e){if(e){var t=document.createElement("SCRIPT");t.src=e,t.async=!0,document.body.appendChild(t)}},this._request=function(t){var r=location.href;location.search?r+="&_pagelet_id="+t.domid:r+="?_pagelet_id="+t.domid;var i=new XMLHttpRequest;i.onload=function(t){var r=i.response,n={};try{n=JSON.parse(r)}catch(e){401===i.status&&_bigviewDebug("access_denied",i.statusText)}n.error=!1,e.view(n)},i.onerror=function(r){e.error(t),console.error(r)},i.open("GET",r,!0),i.setRequestHeader("bigview_error_time",Date.now()),i.send()}};BigEvent.extend(Bigview);var _bigview=new Bigview;_bigview.errorTemplate=_errorTemplate,"function"==typeof define&&define.amd?define("bigview",[],function(){return _bigview}):"object"==typeof exports?module.exports=_bigview:window.bigview=_bigview;
